<% url = Parcelas::Application.routes.url_helpers %>
var Searchbox = function(){

    //functions
    var registerHandlers,
        doSearch,
        getSearchEndpoint,
        setMapModule,
        getMapModule,
        mapModule,
        registerLocationSearchHandlers,
        autocompleter,
        getAutocompleteEndpoint,
        autocompleteMatcher,
        autocompleteHighlighter;

    doSearch = function(query, isNearby){
        getMapModule().search(query, isNearby);
    }

    getAutocompleteEndpoint = function(query){
        var url = '<%= url.autocomplete_json_path(:text => '__query' ) %>';
        url = url.replace('__query', encodeURIComponent(query));
        return url;
    }

    registerLocationSearchHandlers = function(){
        $('a.location-search-button').click(function(){
            var searchBar = $(this).closest('div').find('.location-search-bar');
            var query = searchBar.val();
            var trimmedQuery = $.trim(query);

            if(query.length > 2){
                $('ul.typeahead.dropdown-menu').hide();
                doSearch(trimmedQuery, true);
            }
        });

        $('input.location-search-bar').keyup(function(event){
            var searchButton = $(this).closest('div').find('.location-search-button');
            var trimmedValue = $.trim(this.value);

            if(trimmedValue.length > 2){
                searchButton.removeClass("disabled");
            } else{
                searchButton.addClass("disabled");
            }

            if(event.keyCode == 13 && trimmedValue.length > 2){
                if ($('ul.dropdown-menu:visible li.active').size() > 0) {
                    this.value = trimmedValue = $.trim($('ul.dropdown-menu:visible li.active').attr('data-value'));
                }
                doSearch(trimmedValue, true);
            }

        });

        $('.location-search-typeahead').typeahead({
            source : function(data, process){
                autocompleter('.location-search-bar', data, process);
            },
            minLength : 3,
            matcher : autocompleteMatcher,
            highlighter : autocompleteHighlighter
        });

        $('.discover-button').click(function(){
            doSearch('', true);
        });
    }

    autocompleter = function(currentQueryContainerSelector, query, process){
        var trimmedQuery = $.trim(query);

        if(trimmedQuery.length <= 2){
            return;
        }

        $.getJSON(getAutocompleteEndpoint(trimmedQuery), function(data){
            if(trimmedQuery != $.trim($(currentQueryContainerSelector).val())){
                return;
            }
            process(data.autocomplete);
        });
    }

    autocompleteHighlighter = function (item) {
        var trimmedItem = $.trim(item);
        var trimmedQuery = $.trim(this.query);

        var query = trimmedQuery.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');

        return trimmedItem.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
            return '<strong>' + match + '</strong>'
        });
    }

    autocompleteMatcher = function(item){
        return ~($.trim(item)).toLowerCase().indexOf($.trim(this.query).toLowerCase());
    }

    registerHandlers = function(extraCondition){
        $('.search-bar').keyup(function(event){
            var trimmedValue = $.trim(this.value),
                    searchButton = $(this).closest('div').find('.search-button');

            /*if(trimmedValue.length > 2 && extraCondition()) {
                searchButton.removeClass("disabled");
            } else {
                searchButton.addClass("disabled");
            }*/

            if(event.keyCode == 13 ){
                if ($('ul.dropdown-menu:visible li.active').size() > 0) {
                    this.value = trimmedValue = $.trim($('ul.dropdown-menu:visible li.active').attr('data-value'));
                }
                doSearch(trimmedValue);
            }
        });

        $('.search-button').click(function(){
            var searchBar = $(this).closest('div').find('.search-bar');
            var query = searchBar.val();
            var trimmedQuery = $.trim(query);

            if(query.length > 2){
                doSearch(trimmedQuery);
            }
        });

        $('.typeahead').typeahead({
            source : function(data, process){
                autocompleter('.search-bar', data, process);
            },
            minLength : 3,
            matcher : autocompleteMatcher,
            highlighter : autocompleteHighlighter
        });
    }

    getMapModule = function(){
        return mapModule;
    }

    setMapModule = function(module){
        mapModule = module;
    }

    return {
        init : function(mapModule, extraCondition){
            setMapModule(mapModule);
            registerHandlers(extraCondition);
        },

        registerLocationSearchHandlers : registerLocationSearchHandlers
    }
}();