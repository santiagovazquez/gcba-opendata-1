<% url = Parcelas::Application.routes.url_helpers %>

var Map = function(){

    var buenosAiresLocation;

    var parcelasEndpoint,
        getGeoAddress,
        doDrawParcelasOverGoogleMap,
        drawParcelasOverGoogleMap;

    var canvasWidth = 960,
        canvasHeight = 500,
        centered;

    parcelasEndpoint = function(){
       return '<%= url.secciones_json_path(:seccion => '019') %>';
    }

    getGeoAddress = function(address, callback){
        geocoder = new google.maps.Geocoder();

        geocoder.geocode( { 'address': address}, function(results, status) {
            callback(results[0].geometry.location);
        });
    }

    drawParcelasOverGoogleMap = function(center){
        $.getJSON(parcelasEndpoint(), function(data){
            doDrawParcelasOverGoogleMap(center, data);
        });
    }

    doDrawParcelasOverGoogleMap = function(center, geoJson){
        var $map = $("#map");
        var that = this;

        var map = new google.maps.Map($map[0], {
            zoom: 12,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: center,
            styles:[{"stylers": [{"saturation": -75},{"lightness": 75}]}]
        });

        var overlay = new google.maps.OverlayView();
        overlay.onAdd = function () {

            var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
            var svg = layer.append("svg");
            var adminDivisions = svg.append("g").attr("class", "AdminDivisions");


            overlay.draw = function () {
                var markerOverlay = this;
                var overlayProjection = markerOverlay.getProjection();

                // Turn the overlay projection into a d3 projection
                var googleMapProjection = function (coordinates) {
                    var googleCoordinates = new google.maps.LatLng(coordinates[1] + 0.0005, coordinates[0] - 0.0006);
                    var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
                    return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
                }

                path = d3.geo.path().projection(googleMapProjection);
                adminDivisions.selectAll("path")
                        .data(geoJson.features)
                        .attr("d", path) // update existing paths
                        .enter().append("svg:path")
                        .attr("d", path)
                        .on("click", Sidebar.displayParcela);

                google.maps.event.addDomListener(document.getElementsByTagName("path"), 'click', function() {
                    google.maps.event.trigger(me, 'click');
                });

            };
        };

        overlay.setMap(map);

        $("#loading").hide();
    }

    getMapCenter = function(){
        return buenosAiresLocation;
    }

    setMapCenter = function(center){
        buenosAiresLocation = center;
    }

    return {
        init : function(){
            var that = this;
            getGeoAddress("Buenos Aires", function(center){
                setMapCenter(center);
                drawParcelasOverGoogleMap(center);
            });
        },

         drawOverGoogleMap : function(geoJson){
            doDrawParcelasOverGoogleMap(getMapCenter(), geoJson);
         }
    };
}();