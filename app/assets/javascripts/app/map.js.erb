<% url = Parcelas::Application.routes.url_helpers %>

var Map = function(){

    var buenosAiresLocation = new google.maps.LatLng(-34.61997232, -58.45),
        searchLimit = 200;

    var getEndpointWithQuery,
        drawParcelasOverGoogleMap,
        parcelaClicked,
        mapViewPortChanged,
        getParcelaLatLong,
        showParcelaInfoBox,
        removeOpenedInfobox,
        showSearchInfobox,
        createInfoboxWithHTML,
        emptyParcelaClicked,
        createGoogleLatLong,
        createMap,
        updateViewport,
        removePreviousDrawing,
        getInfoMessageForQuery,
        removeOpenedMarker,
        createSearchMarker;

    var clickedElement,
        temporalMarker,
        searchMarker,
        openedBox;

    var currentZoomLevel = 12,
        currentMapCenter = buenosAiresLocation;

    var idleSkipped = false,
        isMapDragging = false;

    var getIdleSkipped,
        setIdleSkipped,
        getIsMapDragging,
        setIsMapDragging,
        getMapCenter,
        setCurrentMapCenter,
        getCurrentMapCenter,
        getCurrentZoomLevel,
        setCurrentZoomLevel;

    getEndpointWithQuery = function(query, isNearby){
        var lat, long;

        if(isNearby && typeof(temporalMarker) !== 'undefined'){
            lat = temporalMarker.getPosition().lat();
            long = temporalMarker.getPosition().lng();
        } else {
            lat = getCurrentMapCenter().lat();
            long = getCurrentMapCenter().lng();
        }

        var url = '<%= url.pcercanas_json_path(:category => '__cat', :limit => '__limit') %>';
        url = url.replace('__cat', encodeURIComponent(query));
        url = url.replace('__limit', searchLimit);
        return url + '?lat=' + lat + '&long=' + long;
    }

    showSearchInfobox = function(latLong){
        var html = _.template($("#location-search-box-template").html())();

        removeOpenedInfobox();
        createInfoboxWithHTML(html, latLong);
    }

    removeOpenedMarker = function(marker){
        if(typeof(marker) !== 'undefined'){
            marker.setMap(null);
        }
    }

    removeOpenedInfobox = function(){
        removeOpenedMarker(temporalMarker);

        if(typeof(openedBox) !== 'undefined'){
            openedBox.close();
        }
    }

    showParcelaInfoBox = function(parcelas, latLong){
        removeOpenedInfobox();

        var template = $("#parcela_template").html();

        var sanitazedItems = _.map(parcelas.properties.parcelas_data, function(item){
            var newParcela = cloneParcela(item);
            newParcela.smp = newParcela.smp.substring(1);
            return newParcela;
        });

        var html = _.template(template, {items: sanitazedItems});

        createInfoboxWithHTML(html, latLong);
    }

    createInfoboxWithHTML = function(html, latLong) {
        var boxText = document.createElement("div");
        boxText.style.cssText = "border: 1px solid black; margin-top: 8px; background: white; padding: 5px;";
        boxText.innerHTML = html;

        temporalMarker = new google.maps.Marker({
            map: window.__map,
            position: latLong
        });

        var myOptions = {
            content: boxText,
            maxWidth: 800,
            pixelOffset: new google.maps.Size(-140, 0),
            zIndex: null,
            boxStyle: { background: "url('assets/infoBox/tipbox.gif') no-repeat"
                ,opacity: 0.75
                ,width: "500px" },
            closeBoxMargin: "10px 2px 2px 2px",
            closeBoxURL: "assets/infoBox/close.gif",
            infoBoxClearance: new google.maps.Size(1, 1),
            isHidden: false,
            pane: "floatPane",
            enableEventPropagation: false
        }

        openedBox = new InfoBox(myOptions);
        openedBox.open(window.__map, temporalMarker);

        google.maps.event.addListener(openedBox, 'domready', function() {
            $("a.carousel-control.left").click(function() {
                $("#parcela-carousel").carousel("prev");
            });
            $("a.carousel-control.right").click(function() {
                $("#parcela-carousel").carousel("next");
            });

            Searchbox.registerLocationSearchHandlers();
        });
    }

    createSearchMarker = function(isNearbyQuery){
        var position;

        if(isNearbyQuery && typeof(temporalMarker) !== 'undefined'){
            position = temporalMarker.getPosition();
        } else {
            position = getCurrentMapCenter();
        }

        searchMarker = new google.maps.Marker({
            map: window.__map,
            position: position,
            zIndex: 150
        });
    }

    emptyParcelaClicked = function(point){
        showSearchInfobox(createGoogleLatLong(point.lat(), point.lng()));
    }

    parcelaClicked = function(parcela, a, b, c, d){
        if(typeof(clickedElement) !== 'undefined' && clickedElement != null){
            clickedElement.style("stroke", "orange");
            clickedElement.style("fill", "orange");
        }

        clickedElement = d3.select(this);

        clickedElement.style("stroke", "blue");
        clickedElement.style("fill", "blue");

        showParcelaInfoBox(parcela, getParcelaLatLong(parcela));

        d3.event.stopPropagation();
    }

    createGoogleLatLong = function(lat, long){
        return new google.maps.LatLng(lat, long);
    }

    getParcelaLatLong = function(parcela){
        return createGoogleLatLong(parcela.geometry.coordinates[0][0][0][1], parcela.geometry.coordinates[0][0][0][0] - 0.0006);
    }

    createMap = function(){
        var $map = $("#map");

        window.__map = new google.maps.Map($map[0], {
            zoom: getCurrentZoomLevel(),
            minZoom: 12,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: getMapCenter(),
            styles:[{"stylers": [{"saturation": -75},{"lightness": 75}]}]
        });

        google.maps.event.addListener(window.__map, 'idle', function() {
            if (getIsMapDragging()) {
                setIdleSkipped(true);
                return;
            }

            setIdleSkipped(false);
            mapViewPortChanged(window.__map);
        });

        google.maps.event.addListener(window.__map, 'dragstart', function() {
            setIsMapDragging(true);
        });

        google.maps.event.addListener(window.__map, 'dragend', function() {
            setIsMapDragging(false);
            if (getIdleSkipped() == true) {

                mapViewPortChanged(window.__map);
                setIdleSkipped(false);
            }
        });

        google.maps.event.addListener(window.__map, 'bounds_changed', function() {
            setIdleSkipped(false);
        });

        google.maps.event.addDomListener(window.__map, 'click', function(data) {
            emptyParcelaClicked(data.latLng);
        });
    }

    drawParcelasOverGoogleMap = function(geoJson, isNearbyQuery){

        removeOpenedMarker(searchMarker);

        createSearchMarker(isNearbyQuery);

        var overlay = new google.maps.OverlayView();
        overlay.onAdd = function () {


            var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
            var svg = layer.append("svg");
            var adminDivisions = svg.append("g").attr("class", "AdminDivisions");

            overlay.draw = function () {
                var markerOverlay = this;
                var overlayProjection = markerOverlay.getProjection();

                // Turn the overlay projection into a d3 projection
                var googleMapProjection = function (coordinates) {
                    var googleCoordinates = new google.maps.LatLng(coordinates[1] + 0.0005, coordinates[0] - 0.0006);
                    var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
                    return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
                }

                path = d3.geo.path().projection(googleMapProjection);
                adminDivisions.selectAll("path")
                        .data(geoJson.features)
                        .attr("d", path) // update existing paths
                        .enter().append("svg:path")
                        .attr("d", path)
                        .on("click", parcelaClicked);
            };
        };

        overlay.setMap(window.__map);

        google.maps.event.trigger(window.__map, 'resize');
    }

    mapViewPortChanged = function(map){
        var centerLatLong = map.getCenter();
        var zoomLevel = map.getZoom();

        setCurrentMapCenter(centerLatLong);
        setCurrentZoomLevel(zoomLevel);
    };

    setCurrentZoomLevel = function(zoomLevel){
        currentZoomLevel = zoomLevel;
    }

    setCurrentMapCenter = function(center){
        currentMapCenter = center;
    }

    getCurrentMapCenter = function(){
        return currentMapCenter;
    }

    getCurrentZoomLevel = function(){
        return currentZoomLevel;
    }

    getIdleSkipped = function(){
        return idleSkipped;
    }

    setIdleSkipped = function(value){
        idleSkipped = value;
    }

    getIsMapDragging = function(){
        return isMapDragging;
    }

    setIsMapDragging = function(value){
        isMapDragging = value;
    }

    getMapCenter = function(){
        return buenosAiresLocation;
    }

    removePreviousDrawing = function(){
        $(".SvgOverlay").remove();
    }

    getInfoMessageForQuery = function(query, count){
        var plural = (count == 1 ? '' : 's');
        var resultCount = (count == searchLimit ? 'Limitando resultados a ' + searchLimit + '.' :
                                             'Mostrando ' + count + ' resultado' + plural + '.');

        var message = 'Se muestran resultados para la busqueda "' + query + '". ';
        return message + resultCount;
    }

    updateViewport = function(data, query, isNearbyQuery){
        removePreviousDrawing();

        var resultCount = data.features.length;

        if(resultCount == 0){
            StatusBar.showErrorMessage('No hubo resultados para la busqueda "' + query + '"');
        } else{
            StatusBar.showInfoMessage(getInfoMessageForQuery(query, resultCount));
            drawParcelasOverGoogleMap(data, isNearbyQuery);
        }

        removeOpenedInfobox();

        $("#loading").hide();
        $('.navbar-search').show();
    }

    return {
        init : function(){
            var initFun = function() {
                if(window.__map == undefined){
                    createMap();
                }
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    buenosAiresLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    initFun();
                }, initFun);
            } else {
                initFun();
            }

        },

        search : function(query, isNearbyQuery){
            var endpoint = getEndpointWithQuery(query, isNearbyQuery);
            $("#loading").show();
            
            // the z-index of the loader is not enough to be on the top of everything
            // because this component has the focus
            $('.navbar-search').hide();

            $.getJSON(endpoint, function(data){
                updateViewport(data, query, isNearbyQuery);
            });
        }
    };
}();
