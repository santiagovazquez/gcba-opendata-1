var width = 960,
        height = 500,
        centered;

var projection = d3.geo.mercator()
    .scale(600000)
    .translate([-11000, 96100 ]);


var path = d3.geo.path()
        .projection(projection);

var svg = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height);

svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", comunaClicked);

var g = svg.append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        .append("g")
        .attr("id", "states");

d3.json(buildMapUrl(), function(json) {
    g.selectAll("path")
            .data(json.features)
            .enter().append("path")
            .attr("d", path)
            .on("click", comunaClicked);
});

function buildMapUrl(){
    return 'comunas/list/2';
}

function comunaClicked(d) {

    var that = this;

    var x = 0,
            y = 0,
            k = 1;

    if (d && centered !== d) {
        var centroid = path.centroid(d);
        x = -centroid[0];
        y = -centroid[1];
        k = 4;
        centered = d;
    } else {
        centered = null;
    }

    g.selectAll("path")
            .classed("active", centered && function(d) { return d === centered; });

    g.transition()
            .duration(1000)
            .attr("transform", "scale(" + k + ")translate(" + x + "," + y + ")")
            .style("stroke-width", 1.5 / k + "px")
            .each("end", function(){ displayInformation(d) });
}

function displayInformation(node){
    Sidebar.populateBarrio(node.properties);
}